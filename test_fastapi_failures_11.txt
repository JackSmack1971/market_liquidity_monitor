============================= test session starts =============================
platform win32 -- Python 3.13.9, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\click\AppData\Local\Microsoft\WindowsApps\PythonSoftwareFoundation.Python.3.13_qbz5n2kfra8p0\python.exe
cachedir: .pytest_cache
hypothesis profile 'default'
rootdir: C:\Users\click\OneDrive\Documents\mlm\market_liquidity_monitor
plugins: anyio-4.11.0, Faker-40.1.0, hypothesis-6.148.4, langsmith-0.5.1, logfire-4.16.0, asyncio-1.3.0, cov-7.0.0, mock-3.15.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 3 items

tests/test_fastapi_standards.py::test_lifespan_preloads_markets FAILED   [ 33%]
tests/test_fastapi_standards.py::test_orderbook_yield_dependency_and_background_task FAILED [ 66%]
tests/test_fastapi_standards.py::test_analyze_background_task PASSED     [100%]

================================== FAILURES ===================================
_______________________ test_lifespan_preloads_markets ________________________

    @pytest.mark.asyncio
    async def test_lifespan_preloads_markets():
        """Verify that the lifespan event pre-loads markets for priority exchanges."""
        # We patch asyncio.gather in api.main to verify it's called with the preload tasks
        with patch('api.main.asyncio.gather', AsyncMock()) as mock_gather:
            async with AsyncClient(transport=ASGITransport(app=app), base_url="http://test") as ac:
                await ac.get("/api/v1/health")
>               assert mock_gather.called
E               AssertionError: assert False
E                +  where False = <AsyncMock id='2281657160032'>.called

tests\test_fastapi_standards.py:16: AssertionError
_____________ test_orderbook_yield_dependency_and_background_task _____________

    @pytest.mark.asyncio
    async def test_orderbook_yield_dependency_and_background_task():
        """Verify that get_orderbook uses yield dependency and triggers background snapshot."""
        # Mock capture_snapshot on the global tracker instance
        with patch('data_engine.historical.historical_tracker.capture_snapshot', AsyncMock()) as mock_capture:
            # Mock ExchangeClient.fetch_order_book to avoid real network calls
            with patch('api.dependencies.exchange_manager.get_client', AsyncMock()) as mock_get_client:
                mock_client = AsyncMock()
                # Set up as an async context manager
                mock_client.__aenter__.return_value = mock_client
    
                # Create a valid OrderBook dictionary for the mock to return
                valid_orderbook = {
                    "symbol": "BTC/USDT",
                    "exchange": "binance",
                    "timestamp": datetime.utcnow().isoformat(),
                    "bids": [{"price": 99.0, "amount": 1.0}],
                    "asks": [{"price": 101.0, "amount": 1.0}],
                    "best_bid": {"price": 99.0, "amount": 1.0},
                    "best_ask": {"price": 101.0, "amount": 1.0},
                    "spread": 2.0,
                    "spread_percentage": 2.0,
                    "bid_depth_10": 1.0,
                    "ask_depth_10": 1.0
                }
                mock_client.fetch_order_book.return_value = valid_orderbook
                mock_get_client.return_value = mock_client
    
                async with AsyncClient(transport=ASGITransport(app=app), base_url="http://test") as ac:
                    response = await ac.get("/api/v1/orderbook/BTC/USDT?exchange=binance")
    
>                   assert response.status_code == 200
E                   assert 404 == 200
E                    +  where 404 = <Response [404 Not Found]>.status_code

tests\test_fastapi_standards.py:54: AssertionError
============================== warnings summary ===============================
tests/test_fastapi_standards.py::test_orderbook_yield_dependency_and_background_task
  C:\Users\click\OneDrive\Documents\mlm\market_liquidity_monitor\tests\test_fastapi_standards.py:38: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    "timestamp": datetime.utcnow().isoformat(),

tests/test_fastapi_standards.py::test_analyze_background_task
  C:\Users\click\OneDrive\Documents\mlm\market_liquidity_monitor\tests\test_fastapi_standards.py:68: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    "timestamp": datetime.utcnow().isoformat(),

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_fastapi_standards.py::test_lifespan_preloads_markets - Asse...
FAILED tests/test_fastapi_standards.py::test_orderbook_yield_dependency_and_background_task
=================== 2 failed, 1 passed, 2 warnings in 8.54s ===================
