============================= test session starts =============================
platform win32 -- Python 3.13.9, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\click\AppData\Local\Microsoft\WindowsApps\PythonSoftwareFoundation.Python.3.13_qbz5n2kfra8p0\python.exe
cachedir: .pytest_cache
hypothesis profile 'default'
rootdir: C:\Users\click\OneDrive\Documents\mlm\market_liquidity_monitor
plugins: anyio-4.11.0, Faker-40.1.0, hypothesis-6.148.4, langsmith-0.5.1, logfire-4.16.0, asyncio-1.3.0, cov-7.0.0, mock-3.15.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 3 items

tests/test_fastapi_standards.py::test_lifespan_preloads_markets FAILED   [ 33%]
tests/test_fastapi_standards.py::test_orderbook_yield_dependency_and_background_task FAILED [ 66%]
tests/test_fastapi_standards.py::test_analyze_background_task FAILED     [100%]

================================== FAILURES ===================================
_______________________ test_lifespan_preloads_markets ________________________

    @pytest.mark.asyncio
    async def test_lifespan_preloads_markets():
        """Verify that the lifespan event pre-loads markets for priority exchanges."""
        # We must patch where it's USED, which is api.main
        with patch('api.main.exchange_manager.preload_exchange', AsyncMock()) as mock_preload:
            async with AsyncClient(transport=ASGITransport(app=app), base_url="http://test") as ac:
                await ac.get("/api/v1/health")
>               assert mock_preload.call_count >= 3
E               AssertionError: assert 0 >= 3
E                +  where 0 = <AsyncMock id='1904644707328'>.call_count

tests\test_fastapi_standards.py:15: AssertionError
_____________ test_orderbook_yield_dependency_and_background_task _____________

    @pytest.mark.asyncio
    async def test_orderbook_yield_dependency_and_background_task():
        """Verify that get_orderbook uses yield dependency and triggers background snapshot."""
        # Mock capture_snapshot in the module where it's used
>       with patch('data_engine.historical.capture_snapshot', AsyncMock()) as mock_capture:
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\test_fastapi_standards.py:26: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Program Files\WindowsApps\PythonSoftwareFoundation.Python.3.13_3.13.2544.0_x64__qbz5n2kfra8p0\Lib\unittest\mock.py:1497: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <unittest.mock._patch object at 0x000001BB75EA03D0>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'data_engine.historical' from 'C:\\Users\\click\\OneDrive\\Documents\\mlm\\market_liquidity_monitor\\data_engine\\historical.py'> does not have the attribute 'capture_snapshot'

C:\Program Files\WindowsApps\PythonSoftwareFoundation.Python.3.13_3.13.2544.0_x64__qbz5n2kfra8p0\Lib\unittest\mock.py:1467: AttributeError
________________________ test_analyze_background_task _________________________

    @pytest.mark.asyncio
    async def test_analyze_background_task():
        """Verify that /analyze triggers background snapshot when symbol/exchange are provided."""
>       with patch('data_engine.historical.capture_snapshot', AsyncMock()) as mock_capture:
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\test_fastapi_standards.py:46: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Program Files\WindowsApps\PythonSoftwareFoundation.Python.3.13_3.13.2544.0_x64__qbz5n2kfra8p0\Lib\unittest\mock.py:1497: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <unittest.mock._patch object at 0x000001BB75B1D7F0>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'data_engine.historical' from 'C:\\Users\\click\\OneDrive\\Documents\\mlm\\market_liquidity_monitor\\data_engine\\historical.py'> does not have the attribute 'capture_snapshot'

C:\Program Files\WindowsApps\PythonSoftwareFoundation.Python.3.13_3.13.2544.0_x64__qbz5n2kfra8p0\Lib\unittest\mock.py:1467: AttributeError
=========================== short test summary info ===========================
FAILED tests/test_fastapi_standards.py::test_lifespan_preloads_markets - Asse...
FAILED tests/test_fastapi_standards.py::test_orderbook_yield_dependency_and_background_task
FAILED tests/test_fastapi_standards.py::test_analyze_background_task - Attrib...
============================== 3 failed in 7.85s ==============================
