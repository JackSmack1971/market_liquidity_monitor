============================= test session starts =============================
platform win32 -- Python 3.13.9, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\click\AppData\Local\Microsoft\WindowsApps\PythonSoftwareFoundation.Python.3.13_qbz5n2kfra8p0\python.exe
cachedir: .pytest_cache
hypothesis profile 'default'
rootdir: C:\Users\click\OneDrive\Documents\mlm\market_liquidity_monitor
plugins: anyio-4.11.0, Faker-38.2.0, hypothesis-6.148.4, langsmith-0.5.1, logfire-4.16.0, asyncio-1.3.0, cov-7.0.0, mock-3.15.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 3 items

tests/test_database_simple.py::test_db_connection_fail_graceful PASSED   [ 33%]
tests/test_database_simple.py::test_store_snapshot_mock FAILED           [ 66%]
tests/test_database_simple.py::test_db_manager_singleton_import PASSED   [100%]

================================== FAILURES ===================================
__________________________ test_store_snapshot_mock ___________________________

mock_create_engine = <MagicMock name='create_async_engine' id='1926992002560'>
mock_sessionmaker = <MagicMock name='async_sessionmaker' id='1926992001216'>

    @pytest.mark.asyncio
    @patch('market_liquidity_monitor.data_engine.database.async_sessionmaker')
    @patch('market_liquidity_monitor.data_engine.database.create_async_engine')
    async def test_store_snapshot_mock(mock_create_engine, mock_sessionmaker):
        """Test storing snapshot with mocked DB."""
        manager = DatabaseManager()
        manager._is_active = True
    
        mock_session = AsyncMock()
        # session_factory() returns an async context manager
        session_factory = MagicMock()
        mock_sessionmaker.return_value = session_factory
        session_factory.return_value = MockAsyncContextManager(mock_session)
    
        # session.begin() returns another async context manager
        mock_session.begin.return_value = MockAsyncContextManager(AsyncMock())
    
        snapshot_data = {"symbol": "BTC/USDT", "exchange": "binance", "best_bid": 100.0}
>       await manager.store_snapshot(snapshot_data)

tests\test_database_simple.py:41: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <market_liquidity_monitor.data_engine.database.DatabaseManager object at 0x000001C0A9A5F610>
snapshot_data = {'best_bid': 100.0, 'exchange': 'binance', 'symbol': 'BTC/USDT'}

    async def store_snapshot(self, snapshot_data: Dict[str, Any]):
        """Store a new snapshot in the database."""
        if not self._is_active:
            return
    
        async with self.session_factory() as session:
>           async with session.begin():
                       ^^^^^^^^^^^^^^^
E           TypeError: 'coroutine' object does not support the asynchronous context manager protocol

data_engine\database.py:84: TypeError
============================== warnings summary ===============================
data_engine\models.py:199
  C:\Users\click\OneDrive\Documents\mlm\market_liquidity_monitor\data_engine\models.py:199: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class HistoricalSnapshot(BaseModel):

..\..\..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.13_qbz5n2kfra8p0\LocalCache\local-packages\Python313\site-packages\pydantic\_internal\_generate_schema.py:319
  C:\Users\click\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.13_qbz5n2kfra8p0\LocalCache\local-packages\Python313\site-packages\pydantic\_internal\_generate_schema.py:319: PydanticDeprecatedSince20: `json_encoders` is deprecated. See https://docs.pydantic.dev/2.12/concepts/serialization/#custom-serializers for alternatives. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    warnings.warn(

tests/test_database_simple.py::test_store_snapshot_mock
  C:\Users\click\OneDrive\Documents\mlm\market_liquidity_monitor\data_engine\database.py:84: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    async with session.begin():
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_database_simple.py::test_store_snapshot_mock - TypeError: '...
=================== 1 failed, 2 passed, 3 warnings in 7.19s ===================
